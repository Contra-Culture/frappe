<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>frappe.js</title>
    <script type="module" src="util/registry.mjs"></script>
    <script type="module" src="loader.mjs"></script>
    <script type="module">
      import {
        loader as ldr,
      } from "./loader.mjs"

      const loader = ldr(window)

      loader.load(["tools"], {
        title: "objects framework",
        src: "o.mjs",
        async: true,
        defer: false,
      })
      loader.load(["tools"], {
        title: "styling DSL and toolkit",
        src: "style.mjs",
        async: true,
        defer: false,
      })
      loader.load(["tools"], {
        title: "view library",
        src: "view.mjs",
        async: true,
        defer: false,
      })
      loader.load(["tools"], {
        title: "application framework",
        src: "app.mjs",
        async: true,
        defer: false,
      })
      loader.load(["tools"], {
        title: "schema library",
        src: "schema.mjs",
        async: true,
        defer: false,
      })
      loader.load(["tools"], {
        title: "Web Components library",
        src: "webComponent.mjs",
        async: true,
        defer: false,
      })
      loader.load(["tools"], {
        title: "models library",
        src: "model.mjs",
        async: true,
        defer: false,
      })
    </script>

    <script type="module">
      import {
        Universe,
        VM,
      } from "./o.mjs"

      const u = new Universe(
        (stream)=> {
          stream("orderReceived", () => {})
          stream("orderConfirmed", () => {})
          stream("orderRejected", () => {})
          stream("orderPackaged", () => {})
          stream("orderDelivered", () => {})
          stream("orderLost", () => {})
        },
        (object) => {
          object( "orderConfirmator",
                  (props) => { },
                  (prop) => {
                    prop()
                    prop()
                    prop()
                  },
                  (reaction) => {
                    reaction("orderReceived", (msg) => { }, ["orderConfirmed", "orderRejected"])
                  } )
          object( "orderPackager",
                  (props) => { },
                  (prop) => {
                    prop("n", () => {  }, () => {  })
                    prop()
                    prop()
                  },
                  (reaction) => {
                    reaction("orderConfirmed", (msg) => { }, ["orderPackaged"])
                  } )
          object( "orderDeliverer",
                  (props) => {},
                  (prop) => {
                    prop()
                    prop()
                    prop()
                  },
                  (reaction) => {
                    reaction("orderPackaged", (msg) => { }, ["orderDelivered", "orderLost"])
                  } )
        }
      )
      u.inspect()
    </script>
    <script type="module">
      import {
        Univ,
        App,
      } from "./app.mjs"

      import {
        viewGen,
      } from "./view.mjs"

      const view = viewGen((injection) => {
        injection("testInjection", function(dsl) { dsl.safe("<pre>testInjection<pre>") })
      })
      const layout = (data) => {
        return view((dsl, injections) => {
         injections.testInjection()
         dsl.tag("header", null, dsl => {
           dsl.tag("h1", null, dsl => {
             dsl.safe("MyApp")
            })
          })
         dsl.tag("menu", null, dsl => {
           dsl.tag("ul", null, dsl => {
             dsl.tag("li", null, dsl => {
               dsl.tag("a", { class:"menu-link", href:"javascript://void(0);", onclick: "app.URLHelpers.root()"}, dsl => {
                 dsl.safe("Dashboard")
                })
              })
             dsl.tag("li", null, dsl => {
               dsl.tag("a", { class: "menu-link", href: "javascript://void(0);", onclick: "app.URLHelpers.articles()" }, dsl => {
                 dsl.safe("Archive")
                })
              })
            })
          })
         dsl.tag("main", null, dsl => {
           dsl.tag("p", null, dsl => {
             dsl.safe(`Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur facilisis convallis pulvinar. Interdum et malesuada
              fames ac ante ipsum primis in faucibus.Praesent molestie augue tellus, vel volutpat massa vestibulum at.Ut lacus
mauris, iaculis vitae posuere vel, iaculis id purus.Aliquam pellentesque laoreet est ut luctus.Donec nulla orci,
                hendrerit non pulvinar id, viverra vitae libero.Morbi id faucibus risus, nec accumsan mi.Duis ac mollis lacus.Sed
feugiat aliquam ullamcorper.`)
            })
           dsl.tag("p", null, dsl => {
             dsl.safe(`Ut ultrices ante nec varius malesuada. Mauris vel pharetra justo. Pellentesque sit amet ultrices massa. Sed bibendum
hendrerit nibh, non lobortis arcu tempor non. Phasellus in risus quis est tristique scelerisque. Nam quis congue nunc.
Sed eros justo, feugiat eget pharetra in, fringilla elementum ex. Duis id ullamcorper arcu. Aenean venenatis orci
eleifend pretium efficitur. Aliquam vehicula accumsan nulla nec efficitur. Sed eleifend sed diam vitae varius. Fusce vel
sapien nisi. Vestibulum ullamcorper dolor vel dui hendrerit ullamcorper. Suspendisse potenti.`)
            })
           dsl.tag("p", null, dsl => {
             dsl.safe(`Cras elementum metus ac feugiat venenatis. Integer eleifend vitae nulla ut bibendum. Maecenas imperdiet magna quis justo
congue imperdiet. Aenean pellentesque congue luctus. Vivamus mattis sollicitudin semper. Maecenas suscipit libero id
orci aliquet aliquet efficitur facilisis risus. Ut nec venenatis justo.`)
            })
           dsl.tag("p", null, dsl => {
             dsl.safe(`Etiam accumsan placerat dui pretium egestas. Suspendisse fringilla, lectus eget consectetur rutrum, libero velit iaculis
ligula, in laoreet tellus odio a eros. Maecenas eget efficitur massa. Nam sodales velit quis tempor pulvinar. Aenean in
turpis sapien. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Phasellus vel
sem sed dui malesuada condimentum vel in augue. Cras scelerisque convallis volutpat. Etiam ac dapibus felis. Nullam
purus eros, condimentum vel ultricies vitae, tincidunt ac magna.`)
            })
           dsl.tag("p", null, dsl => {
             dsl.safe(`Suspendisse consectetur pretium odio, ac tempus ex tempor a. Interdum et malesuada fames ac ante ipsum primis in
faucibus. Proin felis tellus, bibendum eu dolor sed, cursus tempor arcu. Pellentesque non odio id neque mollis accumsan.
Integer tempus odio eu luctus porta. Pellentesque tempor tincidunt neque tempor commodo. Etiam viverra nisi sed eros
bibendum, a bibendum lacus facilisis. Interdum et malesuada fames ac ante ipsum primis in faucibus.`)
            })
          })
        })
      }

      window.app = new App({
        name: "myApp",
        window,
        HTMLConatainer: document.querySelector("#app"),
        widgetsSpec: {
          "widgetA": {
            prepare: () => { },
            render: () => { },
            exit: () => { },
          },
          "widgetB": {
            prepare: () => { },
            render: () => { },
            exit: () => { },
          },
          "widgetC": {
            prepare: () => { },
            render: () => { },
            exit: () => { },
          },
        },
        layoutsSpec: {
          "main": {
            widgets: [
              "widgetA",
              "widgetB",
              "widgetC",
            ],
            prepare: () => { },
            render: layout,
            exit: () => { },
          },
        },
        screensSpec: {
          "dashboard": {
            layout: "main",
            widgets: [
              "widgetA",
              "widgetB",
              "widgetC",
            ],
            prepare: () => {
              return ``
            },
            render: (data) => {
              return `<div style="width:960px;margin: 50px auto;padding:20px;background-color:#e5e7e9;border:1px solid #a5a7a9;">screen: ${data.screen}</div>`
            },
            exit: () => { },
          },
          "articles": {
            layout: "main",
            widgets: [
              "widgetA",
              "widgetB",
              "widgetC",
            ],
            prepare: () => { },
            render:  (data) => {
              return `<div style="width:960px;margin: 50px auto;padding:20px;background-color:#e5e7e9;border:1px solid #a5a7a9;">screen: ${data.screen}</div>`
            },
            exit:    () => { },
          },
          "article": {
            layout: "main",
            widgets: [
              "widgetA",
              "widgetB",
              "widgetC",
            ],
            prepare: () => { },
            render: (data) => {
              return `<div style="width:960px;margin: 50px auto;padding:20px;background-color:#e5e7e9;border:1px solid #a5a7a9;">screen: ${data.screen}</div>`
            },
            exit: () => { },
          },
        },
        routesSpec: {
          data: {
            screen: "dashboard",
            someVal: true,
          },
          children: {
            "articles": {
              as: "articles",
                data: {
                  screen: "articles",
                  anotherVal: false,
                },
                children: {
                  ":articleID": {
                    as: "article",
                    data: { screen: "article",
                  },
                  matches: (chunk) => { return true }
                }
              }
            }
          }
        },
      })
      console.log("app: ", app, layout({}))
    </script>
    <script type="module">
      import {
        registry,
        notUndefined,
        noisyNotFoundHandler,
        noisyAlreadyDefinedHandler,
        noisyNotValidHandler,
      } from "./util/registry.mjs"

      let {
        getValue,
        setValue,
        getValues,
        hasPath,
      } = registry({
        validator: notUndefined,
        notFoundHandler: noisyNotFoundHandler,
        alreadyDefinedHandler: noisyAlreadyDefinedHandler,
        notValidHandler: noisyNotValidHandler,
      })
      getValue("some/path/Name".split("/"))
      setValue("some/path/Name".split("/"), true)
      getValue("some/path/Name".split("/"))
      setValue("some/path/Name".split("/"), false)
      setValue("some/path/NotUndefined".split("/"), undefined)
    </script>
    <script type="module">
      import {
        stylesRegistry,
        prop,
        stylesheet,
      } from "./style.mjs"

      const stylesReg = stylesRegistry()
      stylesReg.setValue("custom/buttons/plain".split("/"), [{prop: "background-color", values: ["#e5e6e7"]}])

      const cssText = stylesheet({
        registry: stylesReg,
        setup: (dsl) => {
          // dsl.namespace("Some.xml")
          dsl.import({url: "some-path.url", media: "screen"})
          dsl.page({
            selector: ":first", setup: (dsl) => {
              dsl.prop({ prop: "color", values: "#ff0000" })
            }
          })
          dsl.style({selector: "body, html", setup: (dsl) => {
            dsl.mixin("custom/buttons/plain".split("/"))
            dsl.prop({prop: "color", values: "#444444"})
          }})
          dsl.media({media: ["screen", "(min-width: 900px)"], setup: (dsl) => {
            dsl.style({selector: "h1", setup: (dsl) => {
              dsl.prop({prop:"color", values: "#f40569"})
            }})
          }})
        },
      })
      console.log("cssText", cssText)
      const style = document.createElement("style")
      style.textContent = cssText
      document.head.appendChild(style)
    </script>
    <script type="module">
      import {
        ns,
      } from "./webComponent.mjs"

      import {
        stylesRegistry,
        prop,
        stylesheet,
      } from "./style.mjs"

      const wcomp = ns("app")
      const stylesReg = stylesRegistry()
      stylesReg.setValue("custom/buttons/plain".split("/"), [{ prop: "background-color", values: ["#e5e6e7"] }])

      const style = stylesheet({
        registry: stylesReg,
        setup: (dsl) => {
        // dsl.namespace("Some.xml")
        dsl.import({
          url: "some-path.url",
          media: "screen",
        })
        dsl.page({
          selector: ":first",
          setup: (dsl) => {
            dsl.prop({
              prop: "color",
              values: "#ff0000",
            })
          }
        })
        dsl.style({
          selector: "body, html",
          setup: (dsl) => {
            dsl.mixin("custom/buttons/plain".split("/"))
            dsl.prop({
              prop: "color",
              values: "#444444",
            })
          }
        })
        dsl.media({
          media: ["screen", "(min-width: 900px)"],
          setup: (dsl) => {
            dsl.style({
              selector: "h1",
              setup: (dsl) => {
                dsl.prop({
                  prop: "color",
                  values: "#f40569",
                })
              }
            })
          }
        })
      },
      })
      wcomp({
        xtag: "comp",
        attrsSetup: ()=>{},
        style,
        templateSetup: (dsl, injections) => {
          injections.style()
          dsl.tag("h1", {}, (dsl) => {
            dsl.unsafe("Header")
          })
        },
        listensEvents: [
          {
            name: "click",
            handler: (evt) => { console.log("clicked!", evt) }
          },
        ],
        hooks: {
          connected: () => { console.log("<app-comp> connected!")},
          disconnected: () => { console.log("<app-comp> disconnected!") },
          adopted: () => { console.log(tag, "<app-comp> adopted!")},
          attrChanged: (name, oldVal, newVal) => { console.log("<app-comp> attrChanged:", name, oldVal, newVal) },
        }
      })
      document.body.appendChild(document.createElement("app-comp"))
    </script>
    <style>
      html, body {
        margin: 0 20px;
        padding: 0;
      }
      header {
        width: 100%;
        clear:both;
        border:1px solid #e5e7e9;
        padding: 40px;
      }
      header > h1 {
        font-family: sans-serif;
        size: 1.8em;
        color: #46688a;
      }
      menu {
        float: left;
        width: 200px;
        background-color: #d5e7f9;
        padding: 20px;
      }
      menu > ul {
        margin: 0;
        padding: 0;
        list-style-type: none;
        width: 100%;
      }
      menu > ul > li {
        margin: 10px 0;
        width: 100%;
      }
      .menu-link {
        font-family: sans-serif;
        display: block;
        padding: 1em 2em;
        color: #0000cc;
      }
      .menu-link:hover {
        color: #ffffff;
        text-decoration: none;
        font-weight: bold;
        background-color: #46688a;
      }
      main {
        float: left;
        width: 600px;
        background-color: #f5f6f7;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>hello</h1>
    </div>
  </body>
</html>
